---
title: "TARATS"
author: "Shengao Yi"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    theme: cerulean
    highlight: monochrome
    css: custom.css
---

<style>
div.blue pre.r { background-color:#eff3ff; }
</style>

```{r message=FALSE, warning=FALSE, include=FALSE}

#setup


# Rmarkdown global setting
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(fig.align = 'center')

#----------------------------------------------------------------------------------------------------------  

# Import libraries
library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot)# plot correlation plot
library(corrplot)
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(knitr)
library(rmarkdown)
library(RSocrata)
library(viridis)
library(ggplot2)
library(stargazer)
library(XML)
library(data.table)
library(ggpmisc)
library(patchwork)
library(spatstat)
library(raster)
library(classInt)   # for KDE and ML risk class intervals
library(tableHTML)
library(exactextractr)
library(sp)
library(units)
library(lubridate)
library(pscl)
library(cvms)
library(yardstick)
library(plotROC)
library(gganimate)
library(gifski)



#----------------------------------------------------------------------------------------------------------  

# Temp
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
root.dir = "https://github.com/henryfeinstein/musa-rats/blob/main/data/"

# Etc
options(scipen=999)
options(tigris_class = "sf")

#----------------------------------------------------------------------------------------------------------  

# functions

st_c    <- st_coordinates
st_coid <- st_centroid

mapThememin <- function(base_size = 10, title_size = 12, small_size = 8) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = title_size, colour = "black", hjust = 0.5),
    plot.subtitle=element_text(size = base_size, colour = "black", hjust = 0.5, face="italic"),
    plot.caption=element_text(size = small_size, colour = "black", hjust = 0.5),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    strip.text.x = element_text(size = small_size, face="italic"),
    strip.text.y = element_text(size = small_size, face="italic"),
    strip.background = element_rect(colour="transparent", fill="transparent"),
    legend.title = element_text(size = small_size),
    legend.text = element_text(size = small_size),
    legend.key.size = unit(0.4, "cm"))
}

mapThememin2 <- function(base_size = 8, title_size = 10, small_size = 6) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = title_size, colour = "black", hjust = 0.5),
    plot.subtitle=element_text(size = base_size, colour = "black", hjust = 0.5, face="italic"),
    plot.caption=element_text(size = small_size, colour = "black", hjust = 0.5),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.background = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_blank(),
    strip.text.x = element_text(size = base_size),
    strip.text.y = element_text(size = base_size),
    strip.background = element_rect(colour="transparent", fill="transparent"),
    legend.title = element_text(size = small_size),
    legend.text = element_text(size = small_size),
    legend.key.size = unit(0.25, "cm"))
}


corTheme <- function(base_size = 10, title_size = 12, small_size = 8){
  theme(axis.text =  element_blank(), 
        axis.ticks = element_blank(), 
        text = element_text(size = 10),
        panel.background = element_rect(fill = greyPalette5[1]),
        axis.title.x = element_text(size = small_size),
        axis.title.y = element_text(size = small_size),
        plot.subtitle = element_text(hjust = 0.5, size = base_size),
        plot.title = element_text(hjust = 0.5, size = title_size),
        plot.caption=element_text(size = small_size, colour = "black", hjust = 0.5),
        strip.background = element_rect(colour="transparent", fill="transparent"))
}


corTheme2 <- function(base_size = 10, title_size = 12, small_size = 8){
  theme(axis.text =  element_text(size = small_size),
        text = element_text(size = 10),
        panel.background = element_rect(fill = greyPalette5[1]),
        axis.title.x = element_text(size = small_size),
        axis.title.y = element_text(size = small_size),
        plot.subtitle = element_text(hjust = 0.5, size = base_size,  face="italic"),
        plot.title = element_text(hjust = 0.5, size = title_size),
        plot.caption=element_text(size = small_size, colour = "black", hjust = 0.5),
        strip.background = element_rect(colour="transparent", fill="transparent"),
        strip.text.x = element_text(size = small_size, face="italic"),
        strip.text.y = element_text(size = small_size, face="italic"))
}

corTheme3 <- function(base_size = 9, title_size = 11, small_size = 7){
  theme(axis.text =  element_text(size = small_size),
        text = element_text(size = 10),
        panel.background = element_rect(fill = greyPalette5[1]),
        axis.title.x = element_text(size = small_size),
        axis.title.y = element_text(size = small_size),
        plot.subtitle = element_text(hjust = 0.5, size = base_size,  face="italic"),
        plot.title = element_text(hjust = 0.5, size = title_size),
        plot.caption=element_text(size = small_size, colour = "black", hjust = 0.5))
}

corTheme4 <- function(base_size = 9, title_size = 11, small_size = 7){
  theme(axis.text =  element_text(size = small_size),
        text = element_text(size = 10),
        panel.background = element_rect(fill = greyPalette5[1]),
        axis.title.x = element_text(size = small_size),
        axis.title.y.right = element_text(size = small_size),
        plot.subtitle = element_text(hjust = 0.5, size = base_size,  face="italic"),
        plot.title = element_text(hjust = 0.5, size = title_size),
        plot.caption=element_text(size = small_size, colour = "black", hjust = 0.5))
}


q5 <- function(variable) {as.factor(ntile(variable, 5))}

q <- function(variable) {as.factor(ntile(variable, 5))}

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]],
                                  c(.01,.2,.4,.6,.8), na.rm=T),
                         digits = 3))
  }
}

qBr2 <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]]*100,0)/100,
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]],
                                  c(.01,.2,.4,.6,.8), na.rm=T),
                         digits = 3))
  }
}

qBr3 <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(round(quantile(round(df[[variable]]*1000000,0),
                          c(.01,.2,.4,.6,.8), na.rm=T)),0)
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]],
                                  c(.01,.2,.4,.6,.8), na.rm=T),
                         digits = 3))
  }
}

substrRight <- function(x, n){
  substr(x, nchar(x)-n+1, nchar(x))
}


nn_function <- function(measureFrom,measureTo,k) {
  measureFrom_Matrix <- as.matrix(measureFrom)
  measureTo_Matrix <- as.matrix(measureTo)
  nn <- get.knnx(measureTo, measureFrom, k)$nn.dist
  output <- as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint) %>%
    pull()
  return(output)  
}


myCrossValidate <- function(dataset, id, dependentVariable, indVariables) {
  
  allPredictions <- data.frame()
  cvID_list <- unique(dataset[[id]])
  
  for (i in cvID_list) {
    
    thisFold <- i
    cat("This hold out fold is", thisFold, "\n")
    
    fold.train <- filter(dataset, dataset[[id]] != thisFold) %>% as.data.frame() %>% 
      dplyr::select(id, geometry, indVariables, dependentVariable)
    fold.test  <- filter(dataset, dataset[[id]] == thisFold) %>% as.data.frame() %>% 
      dplyr::select(id, geometry, indVariables, dependentVariable)
    
    regression <-
      glm(countMVTheft ~ ., family = "poisson", 
          data = fold.train %>% 
            dplyr::select(-geometry, -id))
    
    thisPrediction <- 
      mutate(fold.test, Prediction = predict(regression, fold.test, type = "response"))
    
    allPredictions <-
      rbind(allPredictions, thisPrediction)
    
  }
  return(st_sf(allPredictions))
}

#----------------------------------------------------------------------------------------------------------  

# Colors ("https://coolors.co/gradient-palette/a8f368-f9035e?number=7")
bluePalette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
blue2Palette5 <- c("#08519c","#3182bd","#6baed6","#bdd7e7","#eff3ff")
H_bluePalette5 <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#252525")
orangePalette5 <- c("#FFF2E8","#FFD6B6","#FEB984","#FE9D51","#FD801F")
orange2Palette5 <- c("#FFDFD0","#FFB89F","#FF926E","#FF6B3D","#FF440C")
greyPalette5 <- c("#f7f7f7","#cccccc","#969696","#636363","#252525")
greenPalette5 <- c("#edf8e9","#bae4b3","#74c476","#31a354","#006d2c")
purplePalette5 <- c("#f2f0f7","#cbc9e2","#9e9ac8","#756bb1","#54278f")

#----------------------------------------------------------------------------------------------------------  

# LoadAPI(Min's key)
census_api_key("4bbe4bead4e5817f6a6b79e62c5bea69e77f1887", overwrite = TRUE)


```

## Ⅰ. Introduction


## Ⅱ. Data

### 2.1 Data Wrangling

Through text mining, based on the field "SERVICENOTES", when we detected words "baited", "treatment" and "treated", this indicated that there are rats activities, set value to one, and when encountered with other words like "no evidence", "no rat burrows" or "no rat activity", we set value to zero.

```{r message=FALSE, warning=FALSE, out.width = '100%', results='hide', fig.keep='all'}

## Address to blocks

a2b <- read.csv("./data/address_units_to_blocks.csv.gz", header = TRUE)

## BBLS to blocks

Bbls <- read.csv("./data/bbls_to_blocks.csv.gz", header = TRUE)

## Cama to blocks
Cama <- read.csv("./data/cama_to_blocks.csv.gz", header = TRUE)


## Environment features
Env_features <- read.csv("./data/env_features.csv.gz", header = TRUE)

## Field validation outcomes
Field_validation <- read.csv("./data/field_validation_outcomes.csv", header = TRUE)

## Final address
Final_address <- read.csv("./data/final_address_to_block_0.csv.gz", header = TRUE)

## Impervious surfaces
Impervious_surfaces <- read.csv("./data/impervious_surfaces.csv.gz", header = TRUE)

## Permits to blocks
Permits2blocks <- read.csv("./data/permits_to_blocks.csv.gz", header = TRUE)

## Load rat infestation dataset and spatialize

Rats <- read.csv("./data/rats_to_blocks.csv.gz", header = TRUE) %>%
  na.omit() %>%
  st_as_sf(.,coords=c("LONGITUDE","LATITUDE"),crs=4326) %>%
  st_transform('ESRI:102685') %>%
  mutate(month = month(ymd_hms(SERVICEORDERDATE)),
         year = year(ymd_hms(SERVICEORDERDATE)))
  


Data311_16 <- st_read("./data/311_City_Service_Requests_in_2016.geojson") %>%
  st_transform('ESRI:102685') %>%
  filter(SERVICECODEDESCRIPTION == "Alley Cleaning" | SERVICECODEDESCRIPTION == "Curb and Gutter Repair" | SERVICECODEDESCRIPTION == "DOEE - Nuisance Odor Complaints" | SERVICECODEDESCRIPTION == "DOEE - General Environmental Concerns" | SERVICECODEDESCRIPTION == "Dead Animal Collection" | SERVICECODEDESCRIPTION == "Illegal Dumping" | SERVICECODEDESCRIPTION == "Pothole" | SERVICECODEDESCRIPTION == "Sanitation Enforcement" | SERVICECODEDESCRIPTION == "Street Cleaning" | SERVICECODEDESCRIPTION == "Trash Collection - Missed" | SERVICECODEDESCRIPTION == "Yard Waste - Missed") %>%
  dplyr::select(SERVICECODEDESCRIPTION, SERVICEORDERDATE, INSPECTIONDATE, LATITUDE, LONGITUDE, WARD) %>%
  mutate(TYPE = case_when(SERVICECODEDESCRIPTION == "Alley Cleaning" ~ "Trash issues", 
                          SERVICECODEDESCRIPTION == "DOEE - Nuisance Odor Complaints" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "DOEE - General Environmental Concerns" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "Dead Animal Collection" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "Illegal Dumping" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "Sanitation Enforcement" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "Street Cleaning" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "Trash Collection - Missed" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "Yard Waste - Missed" ~ "Trash issues",
                          SERVICECODEDESCRIPTION == "Curb and Gutter Repair" ~ "Infrastructure issues",
                          SERVICECODEDESCRIPTION == "Pothole" ~ "Infrastructure issues",
                          ),
         month = month(ymd_hms(SERVICEORDERDATE))
         )

  

## Ward
Ward <- st_read("./data/Wards.geojson") %>%
  st_transform('ESRI:102685') %>% 
  dplyr::select(ward_name = NAME,
         ward_pop_15 = POP_2011_2015)

## Census blocks
Census_blocks <- st_read("./data/Census_Blocks__2010.geojson") %>%
  st_transform('ESRI:102685')

# load street centerlines from DC open data
centerlines <- st_read("./data/Street_Centerlines_2013/Street_Centerlines_2013.geojson") %>% 
  st_transform("ESRI:102685") %>% 
  filter(ROADTYPE == "Street")


```

### 2.2 Feature Engineering

```{r message=FALSE, warning=FALSE, out.width = '100%', results='hide', fig.keep='all'}

# convert street centerlines to block polygons
centerlines_pg <- as.data.frame(st_collection_extract(st_polygonize(st_union(centerlines)))) %>% 
  mutate(block_id = row_number()) %>% 
  st_as_sf()

# join wards to centerline polygons
centerlines_pg <- st_join(centerlines_pg, Ward)


# spatial join to assign each rat datapoint to a block polygon
rats_block_join <- st_join(Rats, centerlines_pg)


# spatial join to assign each 311 datapoint to a block polygon
block_311_join <- st_join(centerlines_pg, Data311_16)

rats_block_join_16 <-
  rats_block_join %>%
  filter(year == "2016")

# count observations per block for mapping
block_dat <- left_join(centerlines_pg, rats_block_join_16 %>% 
                                          st_drop_geometry() %>% 
                                          group_by(block_id, month) %>% 
                                          summarize(inspection_count = n(),
                                                    rats_found_yn = ifelse(1 %in% activity, 1, 0),
                                                    rats_found_count = sum(activity))) %>% 
  mutate(inspection_count = replace_na(inspection_count, 0),
         rats_found_yn = replace_na(rats_found_yn, 0),
         rats_found_count = replace_na(rats_found_count, 0),
         area_acres = as.numeric(st_area(.)) / 43560) %>%
  mutate(found = case_when(rats_found_yn == "0" ~ "not_found",
                            rats_found_yn == "1" ~ "found"))


ggplot() +
  geom_sf(data = block_dat, aes(fill = found), color = "transparent") +
  scale_fill_manual(values = c("not_found" = bluePalette5[1], "found" = bluePalette5[4])) +
  labs(title = "",
       subtitle = "",
       caption = "") +
  mapThememin2()

block_311_total <-
  block_311_join %>%
  group_by(block_id, TYPE) %>% 
  summarize(count = n()) %>%
  na.omit()

# plot 311 data based on blocks and types: Trash and Infrastructure issues
ggplot() +
  geom_sf(data = block_311_total, aes(fill = count), color = "transparent") +
  scale_fill_gradient(low = greyPalette5[1], high = bluePalette5[5]) +
  facet_wrap(~TYPE) +
  labs(title = "",
       subtitle = "",
       caption = "") +
  mapThememin2()

block_311_monthly <-
  block_311_join %>%
  group_by(block_id, TYPE, month)%>% 
  summarize(count = n()) %>%
  na.omit()

ggplot() +
  geom_sf(data = block_311_monthly %>%
            filter(TYPE == "Trash issues"), aes(fill = count), color = "transparent") +
  scale_fill_gradient(low = greyPalette5[1], high = bluePalette5[5]) +
  facet_wrap(~month) +
  labs(title = "Trash issues by month",
       subtitle = "",
       caption = "") +
  mapThememin2()

ggplot() +
  geom_sf(data = block_311_monthly %>%
            filter(TYPE == "Infrastructure issues"), aes(fill = count), color = "transparent") +
  scale_fill_gradient(low = greyPalette5[1], high = bluePalette5[5]) +
  facet_wrap(~month) +
  labs(title = "Infrastructure issues by month",
       subtitle = "",
       caption = "") +
  mapThememin2()

# bar plot: number of 311 data according to month

ggplot(data = Data311_16 %>%
  group_by(month, TYPE) %>% 
  summarize(month_count = n()), aes(x = month, y = month_count))+
  geom_bar(fill=bluePalette5[3], color = "white", size = 0.5, stat = "identity")+
  scale_x_continuous(limits = c(0, 13), breaks = 1:12) +
  facet_wrap(~TYPE) +
  labs(title = "Issues counts by month",
       subtitle = "",
       x = "month",
       y = "counts",
       caption = "")+
  geom_hline(yintercept = 0, size = 0.25, color = greyPalette5[3]) +
  corTheme2()+
  theme(panel.background = element_blank(),
        panel.grid.major.y = element_line(linetype = "longdash", size = 0.25, color = greyPalette5[2]))


```



## Ⅲ. Exploratory Analysis

Trash issues: Alley Cleaning, Nuisance Odor Complaints, General Environmental Concerns, Dead Animal Collection, Illegal Dumping, Sanitation Enforcement, Street Cleaning, Trash Collection, Yard Waste

Infrastructure issues: Curb and Gutter Repair, Pothole

From the bar charts, we can know that the infrastructure issue has the highest reports in Feb, nearly 3000 cases, then continue to decrease. For trash issues, the peak values concentrat from June to September, which may be related to the high temperature, so we should take temperature into consideration. From the point of overview, trash issues are much more than infrastructure issues. From the map, infrastructure issues are mainly located in the west and centeral area, trash issues are more evenly and widely distributed.

### 3.1  Time Analysis


















